version: '3.8'

services:
  # X402 Facilitator (Payment Gateway)
  x402-facilitator:
    build:
      context: ./spl-8004-program/x402-facilitator
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - KORA_RPC_URL=${KORA_RPC_URL:-http://kora:8080}
      - KORA_API_KEY=${KORA_API_KEY}
      - KORA_SIGNER_ADDRESS=${KORA_SIGNER_ADDRESS}
      - SOLANA_RPC_URL=${SOLANA_RPC_URL:-https://api.devnet.solana.com}
      - NETWORK=${NETWORK:-solana-devnet}
      - USDC_MINT=${USDC_MINT:-4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU}
      - MOCK_MODE=${MOCK_MODE:-false}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - spl8004-network

  # Kora RPC (Gasless Signer) - Optional, comment out if running externally
  # kora:
  #   image: solana/kora:latest
  #   ports:
  #     - "8080:8080"
  #   environment:
  #     - KORA_SIGNER_PRIVATE_KEY=${KORA_SIGNER_PRIVATE_KEY}
  #     - RUST_LOG=info
  #   volumes:
  #     - ./kora/kora.toml:/app/kora.toml
  #     - ./kora/signers.toml:/app/signers.toml
  #   command: ["kora", "--config", "/app/kora.toml"]
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3
  #   networks:
  #     - spl8004-network

  # Frontend (React + Vite)
  frontend:
    build:
      context: ./agent-aura-sovereign
      dockerfile: Dockerfile
    ports:
      - "8082:8082"
    environment:
      - VITE_SOLANA_NETWORK=devnet
      - VITE_RPC_ENDPOINT=${VITE_RPC_ENDPOINT:-https://api.devnet.solana.com}
      - VITE_PROGRAM_ID=${VITE_PROGRAM_ID:-SPL8wVx7ZqKNxJk5H2bF8QyGvM4tN3rP9WdE6fU5Kc2}
      - VITE_X402_FACILITATOR_URL=http://x402-facilitator:3000
      - VITE_SPL8004_TREASURY=${VITE_SPL8004_TREASURY:-9x3TDBKE7qFHXmvUUhPMkkSBhLmzazRxQaKwzSrQwcXX}
      - VITE_USDC_MINT=${VITE_USDC_MINT:-4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU}
      - VITE_X404_SERVICE_URL=http://x404-preview:4004
      - VITE_STAKING_SERVICE_URL=http://staking-preview:4010
    depends_on:
      x402-facilitator:
        condition: service_healthy
    networks:
      - spl8004-network

  # X404 Preview API (no on-chain deploy)
  x404-preview:
    build:
      context: ./services/x404-preview
      dockerfile: Dockerfile
    ports:
      - "4004:4004"
    environment:
      - PORT=4004
    volumes:
      - x404-data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4004/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - spl8004-network

  # Staking Preview API (records SOL stake/unstake/claim events)
  staking-preview:
    build:
      context: ./services/staking-preview
      dockerfile: Dockerfile
    ports:
      - "4010:4010"
    environment:
      - PORT=4010
    volumes:
      - staking-data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4010/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - spl8004-network

networks:
  spl8004-network:
    driver: bridge

volumes:
  x404-data:
  staking-data:
